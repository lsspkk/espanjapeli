================================================================================
COMPREHENSIVE EXPLANATION OF THE SVELTE BUILD FAILURE ISSUES
================================================================================

Based on investigation performed on January 9, 2026

Note, found by claude sonnet, fixed by claude opus.
Original cause created by claude opus, when creating first tests or something 
for the svelte. 

EXECUTIVE SUMMARY
================================================================================

The build technically succeeds (exit code 0), but there are CRITICAL TypeScript 
type-checking errors that would cause failures in CI/CD pipelines or when 
running `npm run check`. 

Status: 29 errors and 10 warnings across 20 files

================================================================================
THE CORE PROBLEM: Missing SvelteKit Type Declarations
================================================================================

The root cause is that TypeScript cannot find the type declarations for 
SvelteKit's special `$app/*` modules. These are virtual modules that SvelteKit 
generates at build time, but the type checker (`svelte-check`) is failing to 
resolve them properly.

================================================================================
PRIMARY ISSUES IDENTIFIED
================================================================================

1. MISSING `$app/paths` MODULE (9 occurrences)
--------------------------------------------------------------------------------
Files affected:
- src/lib/services/tipService.ts
- src/routes/+page.svelte
- src/routes/asetukset/+page.svelte
- src/routes/kielten-oppiminen/+page.svelte
- src/routes/kuuntelu/+page.svelte
- src/routes/lukeminen/+page.svelte
- src/routes/muisti/+page.svelte
- src/routes/pipsan-maailma/+page.svelte
- src/routes/sanapeli/+page.svelte
- src/routes/yhdistasanat/+page.svelte

What's happening: These files import `base` from `$app/paths`:

    import { base } from '$app/paths';

The `$app/paths` module is defined in 
node_modules/@sveltejs/kit/types/index.d.ts (line 3093), but TypeScript 
isn't finding it during type checking.


2. MISSING `$app/environment` MODULE (4 occurrences)
--------------------------------------------------------------------------------
Files affected:
- src/lib/services/tts.ts
- src/lib/stores/wordKnowledge.ts
- src/lib/stores/progress.ts
- src/lib/stores/theme.ts

What's happening: These files import `browser` from `$app/environment`:

    import { browser } from '$app/environment';

This is used to detect if code is running in the browser vs. server-side 
rendering context.


3. MISSING `$lib/assets/favicon.svg` TYPE DECLARATION (1 occurrence)
--------------------------------------------------------------------------------
File: src/routes/+layout.svelte

What's happening:

    import favicon from '$lib/assets/favicon.svg';

TypeScript doesn't know how to handle SVG imports. This requires a type 
declaration file.


4. TEST FILES USING NODE.JS GLOBALS WITHOUT TYPE DEFINITIONS
--------------------------------------------------------------------------------

Problem A: `global` object (8 occurrences in tipService.test.ts)

    global.fetch = vi.fn();

The `global` object is a Node.js global, but TypeScript doesn't recognize it 
because the types aren't properly configured for the test environment.

Problem B: Node.js modules in tests (3 occurrences in pipsan-ystavat.test.ts)

    import { readFileSync } from 'fs';
    import { resolve } from 'path';

These Node.js built-in modules (`fs`, `path`) and the `__dirname` global 
aren't typed because the test files don't have proper Node.js type 
declarations.

================================================================================
WHY THE BUILD SUCCEEDS BUT TYPE CHECKING FAILS
================================================================================

This is the interesting paradox:

1. `npm run build` SUCCEEDS because:
   - Vite's build process doesn't run strict TypeScript type checking by default
   - The SvelteKit plugin properly resolves these virtual modules at runtime
   - The actual JavaScript code generation works fine

2. `npm run check` FAILS because:
   - `svelte-check` runs a separate TypeScript compiler pass
   - It's more strict and requires all type declarations to be resolvable
   - The .svelte-kit/tsconfig.json extends properly, but something in the 
     type resolution chain is broken

================================================================================
ROOT CAUSE ANALYSIS
================================================================================

Looking at the configuration:

1. tsconfig.json extends .svelte-kit/tsconfig.json ✅

2. .svelte-kit/tsconfig.json has paths configured:

    "paths": {
      "$lib": ["../src/lib"],
      "$lib/*": ["../src/lib/*"],
      "$app/types": ["./types/index.d.ts"]
    }
   
   NOTICE: Only `$app/types` is mapped, but NOT `$app/paths` or 
   `$app/environment`!

3. The ambient types reference @sveltejs/kit:

    /// <reference types="@sveltejs/kit" />

4. The actual declarations exist in node_modules/@sveltejs/kit/types/index.d.ts:

    declare module '$app/paths' { ... }
    declare module '$app/environment' { ... }

================================================================================
WHY THIS HAPPENS
================================================================================

The issue appears to be a SVELTEKIT SYNC PROBLEM. The .svelte-kit directory 
should be automatically generated and kept in sync, but something has gone 
wrong:

1. The `svelte-kit sync` command should generate proper type mappings
2. The .svelte-kit/ambient.d.ts file references @sveltejs/kit types
3. But TypeScript's module resolution isn't finding the $app/* module 
   declarations

This could be caused by:

- INCOMPLETE `svelte-kit sync` EXECUTION
  The generated types are outdated or incomplete

- TYPESCRIPT MODULE RESOLUTION ISSUES
  The `moduleResolution: "bundler"` setting might not be resolving ambient 
  module declarations correctly

- MISSING TYPE REFERENCE PATHS
  The generated .svelte-kit files might not be properly linking to the 
  SvelteKit type definitions

- VERSION COMPATIBILITY ISSUES
  SvelteKit 2.49.2 might have introduced changes in how types are generated

================================================================================
ADDITIONAL ISSUES FOUND
================================================================================

ACCESSIBILITY WARNINGS (10 warnings - non-blocking but indicate UX issues)
--------------------------------------------------------------------------------
- Missing `tabindex` on dialog elements (3 occurrences)
- Missing form label associations (3 occurrences)  
- Inappropriate use of `autofocus` (4 occurrences)

CSS WARNING (1 warning - non-blocking)
--------------------------------------------------------------------------------
DaisyUI is using `@property --radialprogress` which some CSS processors don't 
recognize, but this doesn't break functionality.

================================================================================
IMPACT ASSESSMENT
================================================================================

CURRENT STATE:
--------------------------------------------------------------------------------
✅ Development server works (`npm run dev`)
✅ Production build works (`npm run build`)
❌ Type checking fails (`npm run check`)
❌ CI/CD pipeline would fail if it runs type checking
❌ IDE type hints are broken for affected imports
❌ Refactoring safety is compromised

RISK LEVEL: HIGH for production deployment because:
--------------------------------------------------------------------------------
1. Type errors could hide real bugs
2. CI/CD might fail unexpectedly
3. Future refactoring will be error-prone
4. Team collaboration is harder without proper types

================================================================================
DETAILED ERROR LIST
================================================================================

TypeScript Errors (29 total):
--------------------------------------------------------------------------------
1. Cannot find module '$app/paths' (9 files)
2. Cannot find module '$app/environment' (4 files)
3. Cannot find module '$lib/assets/favicon.svg' (1 file)
4. Cannot find name 'global' (8 occurrences in tests)
5. Cannot find module 'fs' (1 file)
6. Cannot find module 'path' (1 file)
7. Cannot find name '__dirname' (2 occurrences)

Accessibility Warnings (10 total):
--------------------------------------------------------------------------------
1. Elements with 'dialog' role must have tabindex (3 occurrences)
2. Form labels must be associated with controls (3 occurrences)
3. Avoid using autofocus (4 occurrences)

CSS Warnings (1 total):
--------------------------------------------------------------------------------
1. Unknown at rule: @property (DaisyUI radial progress)

================================================================================
SUMMARY
================================================================================

The Svelte game build has a TypeScript type resolution failure where 
SvelteKit's virtual modules ($app/paths, $app/environment) and some asset 
imports aren't being properly recognized by the type checker. 

This is likely due to an incomplete or corrupted .svelte-kit generated types 
directory. 

While the build technically succeeds because Vite doesn't enforce strict type 
checking, any CI/CD pipeline running `npm run check` or similar validation 
would fail with 29 errors and 10 warnings across 20 files.

================================================================================
RECOMMENDED FIX APPROACH
================================================================================

The fix would involve:

1. Regenerating the SvelteKit types (svelte-kit sync)
2. Adding proper type declarations for SVG imports
3. Configuring the test environment with proper Node.js types
4. Ensuring TypeScript can resolve the $app/* virtual modules
5. Fixing accessibility issues (optional but recommended)

================================================================================
END OF REPORT
================================================================================
